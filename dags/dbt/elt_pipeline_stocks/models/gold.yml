version: 2
models:
  # =======================================================
  # DIMENSIONS (DIM)
  # =======================================================
  - name: dim_date
    description: >
      Time dimension table that contains attributes for weekly granularity.
      Used to filter and group pricing data by time.
    columns:
      # PRIMARY KEY (PK) Test
      - name: date_id
        description: Primary key of the time dimension (surrogate key).
        tests:
          - unique
          - not_null
      # Business Keys/Attributes Tests
      - name: week_ending
        description: The date marking the end of the trading week (usually Friday).
        tests:
          - not_null
          # Ensures the date is within a reasonable range (e.g., 2000-2030)
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "2000-01-01"
              max_value: "2030-12-31"

  - name: dim_stock
    description: >
      Stock dimension table. Contains metadata for companies and their tickers.
    columns:
      # PRIMARY KEY (PK) Test
      - name: stock_id
        description: Primary key of the stock dimension (surrogate key).
        tests:
          - unique
          - not_null
      # Business Key (BK) Test
      - name: symbol
        description: Stock ticker (e.g., AAPL).
        tests:
          - unique # Must be unique
          - not_null # Cannot be null
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: "^[A-Z0-9]+$" # Ensures it is a valid ticker (uppercase letters/numbers)

  # =======================================================
  # FACTS (FACT)
  # =======================================================
  - name: fact_stock_prices
    description: >
      Fact table containing weekly prices and volumes,
      with derived metrics such as return. The granularity is Stock x Week.
    columns:
      # FOREIGN KEY (FK) Tests (Referential Integrity)
      - name: stock_id
        description: Foreign key to the dim_stock table.
        tests:
          - not_null
          - relationships: # The CRITICAL test for referential integrity (FK -> PK)
              to: ref('dim_stock')
              field: stock_id
      - name: date_id
        description: Foreign key to the dim_date table.
        tests:
          - not_null
          - relationships: # The CRITICAL test for referential integrity (FK -> PK)
              to: ref('dim_date')
              field: date_id

      # PRIMARY KEY Composition Test
      - name: composite_key
        description: "Composed of stock_id and date_id. Cannot have duplicates."
        tests:
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - stock_id
                - date_id

      # Metric Tests (Business Validation)
      - name: adjusted_close
        description: Adjusted closing price. Main metric.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_positive # Prices must be positive

      - name: volume
        description: Weekly trading volume.
        tests:
          - not_null
          - dbt_expectations.expect_column_min_to_be_greater_than:
              min_value: 0 # Volume must be greater than 0 for real trading entries
