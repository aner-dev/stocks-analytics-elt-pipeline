# dimensions.yml
# contract of quality and truth
# guarantee referential integrity & star schema correct appliaction

version: 2
models:
  # =======================================================
  # DIMENSIONS (DIM)
  # =======================================================
  - name: dim_date
    description: >
      Time dimension table that contains attributes for weekly granularity.
      Used to filter and group pricing data by time.
    columns:
      # PRIMARY KEY (PK) Test
      - name: date_id
        description: Primary key of the time dimension (surrogate key).
        tests:
          - unique
          - not_null
      # Business Keys/Attributes Tests
      - name: week_ending
        description: The date marking the end of the trading week (usually Friday).
        tests:
          - not_null
          # Ensures the date is within a reasonable range (e.g., 2000-2030)
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: "'1900-01-01'"
                max_value: "'2050-12-31'"

  - name: dim_stock
    description: >
      Stock dimension table. Contains metadata for companies and their tickers.
      Column names are standardized for analytical consumption.
    columns:
      # PRIMARY KEY (PK) Test
      - name: stock_id
        description: Primary key of the stock dimension (surrogate key).
        tests:
          - unique
          - not_null
      # Business Key (BK) Test
      - name: symbol
        description: Stock ticker (e.g., AAPL).
        tests:
          - unique # Must be unique
          - not_null # Cannot be null
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: "^[A-Z0-9\\.]+$" # Ensures it is a valid ticker (uppercase letters/numbers)
              config:
                severity: warn

  - name: dim_source
    description: >
      Metadata dimension that tracks data provenance. 
      Essential for data lineage and identifying the source of truth.
    columns:
      # PRIMARY KEY (PK)
      - name: source_id
        description: Primary key (Surrogate Key) based on source name and version.
        data_tests:
          - unique
          - not_null

      # Business Attributes
      - name: source_name
        description: Unique identifier for the data provider (e.g., alpha_vantage).
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: ["alpha_vantage", "yahoo_finance", "manual_upload"]
                config:
                  severity: warn # Avisa si aparece una fuente nueva no mapeada

      - name: source_tier
        description: Reliability tier of the source (e.g., Gold, Silver, Bronze).
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: ["Gold", "Silver", "Bronze"]

      - name: update_frequency
        description: Expected data refresh rate.
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: ["Daily", "Weekly", "Monthly", "Real-time"]

      - name: documentation_url
        description: Link to API or source documentation.
        data_tests:
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: "^https?://.*" # URL validation
